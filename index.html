<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>抽籤機 v1.9.1（相容版・可攜式單檔）</title>
<style>
  :root{--primary:#2563eb;--grade:#1982c4;--class:#8ac926;--seat:#ff595e;--bg:#f2f4f8;--card:#fff;--text:#0f172a;--muted:#6b7280;--warn:#dc2626;--shadow:0 6px 18px rgba(2,6,23,.08);--radius:18px;--transition:all .25s ease}
  html,body{height:100%}
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Noto Sans TC","Microsoft JhengHei",Arial,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:24px;line-height:1.6}
  h1{margin:0 auto 12px;text-align:center;font-weight:800;letter-spacing:.02em;font-size:clamp(22px,3.3vw,36px);color:#111827;position:relative;width:fit-content}
  h1::after{content:"";display:block;height:4px;border-radius:2px;background:linear-gradient(90deg,var(--grade),var(--class),var(--seat));margin-top:8px}
  .diag{max-width:1200px;margin:0 auto 10px;color:#0a7d17;font-weight:700;text-align:center}

  .toolbar{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:center;background:var(--card);padding:14px;border-radius:14px;box-shadow:var(--shadow);max-width:1020px;margin:0 auto 18px}
  .toolbar .group{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  label{font-size:.95rem;color:#334155}
  input[type=number]{appearance:textfield;-moz-appearance:textfield;width:110px;max-width:40vw;padding:10px 12px;border:2px solid #e5e7eb;border-radius:10px;font-size:1rem;transition:var(--transition);background:#fff}
  input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 4px rgba(37,99,235,.15)}
  .btn{border:none;border-radius:10px;padding:10px 16px;font-weight:700;cursor:pointer;transition:var(--transition);color:#fff}
  .btn:hover{transform:translateY(-1px);filter:brightness(1.05)}
  .btn-primary{background:var(--primary)}.btn-ghost{background:#111827}.btn-clear{background:#a3a3a3}.btn-reset{background:#fb7185}.btn-full{background:#111827}.btn-accent{background:#0ea5e9}
  .btn:disabled{opacity:.55;cursor:not-allowed;transform:none;filter:none}
  .tiny{font-size:.86rem;color:var(--muted)}.divider{height:1px;width:100%;background:#e5e7eb}

  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px;max-width:1200px;margin:0 auto}
  .card{background:var(--card);border-radius:var(--radius);padding:18px 18px 16px;box-shadow:var(--shadow);transition:var(--transition)}
  .card:hover{transform:translateY(-3px)}
  .options{display:flex;gap:16px;align-items:center;justify-content:center;margin-bottom:12px;flex-wrap:wrap}
  .check{display:flex;gap:8px;align-items:center}.check input{width:18px;height:18px}
  .range{display:grid;grid-template-columns:1fr 1fr;gap:10px;align-items:end}
  .range label{font-size:.9rem;color:#475569}
  .draw-btn{width:100%;margin-top:12px}.draw-grade{background:var(--grade)}.draw-class{background:var(--class)}.draw-seat{background:var(--seat)}
  .result{margin-top:12px;height:120px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:clamp(32px,6vw,72px);position:relative;overflow:hidden;color:#111827}
  .result::before{content:"";position:absolute;inset:0;opacity:.07;background:currentColor}
  .grade{color:var(--grade)}.clazz{color:var(--class)}.seat{color:var(--seat)}
  .rolling{animation:roll .28s ease-in-out infinite}
  @keyframes roll{0%{transform:translateY(-70%);opacity:.2}50%{transform:translateY(0);opacity:1}100%{transform:translateY(70%);opacity:.2}}

  .status{max-width:1200px;margin:16px auto 8px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  #count{font-weight:700;color:#1f2937}
  #progress{height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden;flex:1;min-width:180px}
  #progress>div{height:100%;width:0%;background:var(--primary);transition:width .2s ease}
  .warning{max-width:1200px;margin:0 auto 6px;color:var(--warn);font-weight:700;text-align:center;min-height:22px}
  .log{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:12px;max-width:1200px;margin:10px auto 0}
  .log .item{background:#fff;border-radius:12px;padding:12px;text-align:center;box-shadow:var(--shadow);font-weight:700}

  /* 手機底部記錄按鈕 */
  .record-fab{display:none;position:fixed;left:16px;right:16px;bottom:16px;background:#0ea5e9;color:#fff;text-align:center;border-radius:14px;padding:14px 18px;font-weight:800;box-shadow:0 8px 24px rgba(2,6,23,.18);z-index:10000}
  .record-fab.disabled{opacity:.5;pointer-events:none}
  @media (max-width:768px){body{padding:16px}.grid{grid-template-columns:1fr}.toolbar{justify-content:stretch}.toolbar .group{justify-content:center}.result{height:100px}.record-fab{display:block}}

  /* 列印精簡版 */
  .print-header{display:none}
  @media print{body{background:#fff;padding:0}.toolbar,.grid,.status,#warning,.record-fab{display:none!important}.print-header{display:block;max-width:1200px;margin:18px auto 6px;padding:0 16px;font-weight:800;font-size:20px;color:#111827}.log{max-width:1200px;margin:0 auto;grid-template-columns:1fr;gap:0}.log .item{border:1px solid #e5e7eb;border-radius:0;box-shadow:none;text-align:left;padding:10px 16px;font-weight:600;font-size:18px}}

  /* 彩帶畫布 */
  #confettiCanvas{position:fixed;inset:0;width:100%;height:100%;pointer-events:none;display:none;z-index:9999}
</style>
</head>
<body>
  <h1>抽籤機 v1.9.1</h1>
  <div id="diag" class="diag">JS 初始化中…</div>

  <div class="toolbar" role="region" aria-label="抽籤控制列">
    <div class="group">
      <label for="drawCount">一次抽</label>
      <input type="number" id="drawCount" min="1" max="10" value="1" aria-label="每次抽取數量" />
      <span>個（1–10）</span>
      <button class="btn btn-primary" id="btnDrawAll" title="抽籤（Enter）">抽籤</button>
      <button class="btn btn-accent" id="btnRecord" title="記錄這筆結果（R）">記錄這筆結果</button>
    </div>
    <div class="divider"></div>
    <div class="group">
      <label class="check" title="開啟後，三項都要有值才可記錄"><input type="checkbox" id="onlyFullRecord" /> 只允許完整才可記錄</label>
      <button class="btn btn-ghost" id="btnPrint" title="列印精簡版（只列出清單）">列印清單</button>
      <button class="btn btn-clear" id="btnClearLog" title="清除紀錄（僅下方清單與本機儲存）">清除紀錄</button>
      <button class="btn btn-reset" id="btnResetAll" title="重置所有設定與狀態">全部重置</button>
      <button class="btn btn-full" id="btnFullscreen" title="全螢幕顯示">全螢幕</button>
    </div>
    <div class="tiny">離線可用・單一 HTML 檔・結果自動保存至本機（localStorage）</div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="options">
        <label class="check"><input type="checkbox" id="fixed-grade"/> 固定</label>
        <label class="check"><input type="checkbox" id="norepeat-grade"/> 不重複</label>
      </div>
      <div class="range">
        <div><label for="gradeMin">最小年級</label><input type="number" id="gradeMin" min="1" max="12" value="1"/></div>
        <div><label for="gradeMax">最大年級</label><input type="number" id="gradeMax" min="1" max="12" value="6"/></div>
      </div>
      <button class="btn draw-btn draw-grade" id="btnDrawGrade">抽年級</button>
      <div class="result grade" id="gradeResult">?</div>
    </div>

    <div class="card">
      <div class="options">
        <label class="check"><input type="checkbox" id="fixed-class"/> 固定</label>
        <label class="check"><input type="checkbox" id="norepeat-class"/> 不重複</label>
      </div>
      <div class="range">
        <div><label for="classMin">最小班級</label><input type="number" id="classMin" min="1" max="20" value="1"/></div>
        <div><label for="classMax">最大班級</label><input type="number" id="classMax" min="1" max="20" value="4"/></div>
      </div>
      <button class="btn draw-btn draw-class" id="btnDrawClass">抽班級</button>
      <div class="result clazz" id="classResult">?</div>
    </div>

    <div class="card">
      <div class="options">
        <label class="check"><input type="checkbox" id="fixed-seat"/> 固定</label>
        <label class="check"><input type="checkbox" id="norepeat-seat"/> 不重複</label>
      </div>
      <div class="range">
        <div><label for="seatMin">最小座號</label><input type="number" id="seatMin" min="1" max="120" value="1"/></div>
        <div><label for="seatMax">最大座號</label><input type="number" id="seatMax" min="1" max="120" value="30"/></div>
      </div>
      <button class="btn draw-btn draw-seat" id="btnDrawSeat">抽座號</button>
      <div class="result seat" id="seatResult">?</div>
    </div>
  </div>

  <div class="status">
    <div id="count">已抽了 0 個</div>
    <div id="progress" aria-label="批次進度"><div></div></div>
  </div>
  <div id="warning" class="warning" role="alert"></div>
  <div id="printHeader" class="print-header"></div>
  <div class="log" id="resultsLog"></div>

  <!-- 手機底部記錄按鈕 -->
  <div class="record-fab" id="fabRecord">記錄這筆結果</div>

  <canvas id="confettiCanvas"></canvas>

<script>
(function(){
  'use strict';
  var diagEl=document.getElementById('diag');
  function diag(msg,ok){ if(diagEl){ diagEl.textContent=msg; diagEl.style.color=ok?'#0a7d17':'#b91c1c'; } }
  try{ diag('JS 初始化完成 ✅',true); }catch(e){}

  // ===== ES5 相容 =====
  var gradeWords=['一','二','三','四','五','六','七','八','九','十','十一','十二'];
  var classWords=['甲','乙','丙','丁','戊','己','庚','辛','壬','癸'];
  var currentGrade=null,currentClass=null,currentSeat=null;
  var gradeHistory=[],classHistory=[],seatHistory=[];
  var resultsHistory=[];

  function $id(id){ return document.getElementById(id); }
  var els={
    drawCount:$id('drawCount'), btnDrawAll:$id('btnDrawAll'),
    btnPrint:$id('btnPrint'), btnClearLog:$id('btnClearLog'), btnResetAll:$id('btnResetAll'), btnFullscreen:$id('btnFullscreen'),
    fixedGrade:$id('fixed-grade'), noRepeatGrade:$id('norepeat-grade'), gradeMin:$id('gradeMin'), gradeMax:$id('gradeMax'), btnDrawGrade:$id('btnDrawGrade'), gradeResult:$id('gradeResult'),
    fixedClass:$id('fixed-class'), noRepeatClass:$id('norepeat-class'), classMin:$id('classMin'), classMax:$id('classMax'), btnDrawClass:$id('btnDrawClass'), classResult:$id('classResult'),
    fixedSeat:$id('fixed-seat'), noRepeatSeat:$id('norepeat-seat'), seatMin:$id('seatMin'), seatMax:$id('seatMax'), btnDrawSeat:$id('btnDrawSeat'), seatResult:$id('seatResult'),
    count:$id('count'), progress:document.querySelector('#progress > div'), warning:$id('warning'), resultsLog:$id('resultsLog'), printHeader:$id('printHeader'),
    btnRecord:$id('btnRecord'), fabRecord:$id('fabRecord'), onlyFull:$id('onlyFullRecord')
  };

  // 全域錯誤顯示
  window.addEventListener('error',function(e){ if(els.warning){ els.warning.textContent='⚠️ 腳本錯誤：'+(e.message||e.error||'未知'); diag('腳本錯誤，請看紅字訊息',false); } });

  function setWarning(msg){ if(els.warning) els.warning.textContent=msg||''; }
  function updateCount(){ if(els.count) els.count.textContent='已抽了 '+resultsHistory.length+' 個'; }
  function updateLog(){
    if(els.resultsLog){
      var html=''; for(var i=0;i<resultsHistory.length;i++){ html+='<div class="item">'+resultsHistory[i]+'</div>'; }
      els.resultsLog.innerHTML=html;
    }
    updateCount();
    try{ localStorage.setItem('lottery_results', JSON.stringify(resultsHistory)); }catch(e){}
  }
  function restore(){ try{ var raw=localStorage.getItem('lottery_results'); if(raw){ var arr=JSON.parse(raw); if(arr && arr.constructor===Array){ resultsHistory=arr; updateLog(); } } }catch(e){} }
  function resetAll(){
    currentGrade=currentClass=currentSeat=null; gradeHistory=[]; classHistory=[]; seatHistory=[]; resultsHistory=[];
    if(els.gradeResult) els.gradeResult.textContent='?'; if(els.classResult) els.classResult.textContent='?'; if(els.seatResult) els.seatResult.textContent='?';
    if(els.progress) els.progress.style.width='0%'; if(els.drawCount) els.drawCount.value=1;
    if(els.gradeMin) els.gradeMin.value=1; if(els.gradeMax) els.gradeMax.value=6; if(els.classMin) els.classMin.value=1; if(els.classMax) els.classMax.value=4; if(els.seatMin) els.seatMin.value=1; if(els.seatMax) els.seatMax.value=30;
    if(els.fixedGrade) els.fixedGrade.checked=false; if(els.noRepeatGrade) els.noRepeatGrade.checked=false; if(els.fixedClass) els.fixedClass.checked=false; if(els.noRepeatClass) els.noRepeatClass.checked=false; if(els.fixedSeat) els.fixedSeat.checked=false; if(els.noRepeatSeat) els.noRepeatSeat.checked=false;
    if(els.onlyFull) els.onlyFull.checked=false;
    setWarning(''); updateLog(); try{localStorage.removeItem('lottery_results');}catch(e){}
    refreshRecordButtons();
  }

  function getRandomInt(min,max){ min=Math.ceil(parseInt(min,10)); max=Math.floor(parseInt(max,10)); if(min>max) return min; if(window.crypto && window.crypto.getRandomValues){ var u=new Uint32Array(1); window.crypto.getRandomValues(u); var r=u[0]/0xFFFFFFFF; return Math.floor(r*(max-min+1))+min; } return Math.floor(Math.random()*(max-min+1))+min; }
  function labelOf(t){ return t==='grade'?'年級':(t==='class'?'班級':'座號'); }
  function wordOf(t,n){ if(t==='grade') return gradeWords[n-1]||String(n); if(t==='class') return classWords[n-1]||String(n); return String(n); }
  function includes(arr,v){ for(var i=0;i<arr.length;i++){ if(arr[i]===v) return true; } return false; }

  // 單項抽取（新增 onDone 回呼）：確保外部能「等待動畫結束」
  function drawOne(opts){
    var min=opts.min, max=opts.max, resultEl=opts.resultEl, type=opts.type, fixed=opts.fixed, noRepeat=opts.noRepeat, history=opts.history, animate=(opts.animate!==false), onDone=opts.onDone;
    if(!resultEl){ if(onDone) onDone(null); return null; }
    if(fixed && resultEl.dataset && resultEl.dataset.value!=null){ if(onDone) onDone(parseInt(resultEl.dataset.value,10)); return parseInt(resultEl.dataset.value,10); }
    min=parseInt(min,10); max=parseInt(max,10);
    if(!(min>=1&&max>=1) || min>max){ setWarning('範圍超過限制！請檢查最小/最大值'); if(onDone) onDone(null); return null; }
    var rangeSize=(max-min+1);
    if(noRepeat && history.length>=rangeSize){ setWarning(labelOf(type)+' 範圍（'+min+'～'+max+'）已抽完，請擴充範圍或取消「不重複」'); if(onDone) onDone(null); return null; }

    if(animate){
      resultEl.style.transform='scale(.97)'; setTimeout(function(){ resultEl.style.transform='scale(1)'; },180);
      var iv=setInterval(function(){
        var num=getRandomInt(min,max);
        if(noRepeat && includes(history,num)){ var guard=0; while(includes(history,num)&&guard<50){ num=getRandomInt(min,max); guard++; } }
        resultEl.innerHTML='<span class="rolling">'+wordOf(type,num)+'</span>';
      },100);
      setTimeout(function(){ clearInterval(iv); finalize(); },1200);
    }else{ finalize(); }

    function finalize(){
      var finalNum=getRandomInt(min,max);
      if(noRepeat){
        var guard=0; while(includes(history,finalNum)&&guard<500){ finalNum=getRandomInt(min,max); guard++; }
        if(guard>=500){ setWarning('無法產生新值，請調整範圍或取消不重複'); if(onDone) onDone(null); return; }
      }
      resultEl.innerHTML='<span>'+wordOf(type,finalNum)+'</span>';
      if(resultEl.dataset) resultEl.dataset.value=String(finalNum);
      if(noRepeat && !includes(history,finalNum)) history.push(finalNum);

      if(type==='grade') currentGrade=wordOf('grade',finalNum);
      else if(type==='class') currentClass=wordOf('class',finalNum);
      else currentSeat=finalNum;

      refreshRecordButtons();
      if(onDone) onDone(finalNum);
    }
    return null;
  }

  // 蒐集目前畫面狀態
  function snapshot(){
    var g=currentGrade, c=currentClass, s=currentSeat;
    var parts=[], isFull=(!!g && !!c && s!=null);
    if(g) parts.push('年級：'+g);
    if(c) parts.push('班級：'+c);
    if(s!=null) parts.push('座號：'+s);
    return {g:g,c:c,s:s,isFull:isFull,parts:parts,fullText:(isFull? (g+'年'+c+'班'+s+'號') : parts.join('｜'))};
  }

  // 記錄一筆（可選是否放彩帶）
  function addLogWithEffects(text, playConfetti){
    var last = resultsHistory.length? resultsHistory[resultsHistory.length-1] : null;
    if(last===text){
      if(!confirm('與上一筆相同，要重複記錄嗎？')) return;
    }
    resultsHistory.push(text);
    updateLog();
    if(playConfetti) startConfetti(2000);
    diag('✅ 已記錄', true); setTimeout(function(){ diag('JS 初始化完成 ✅', true); },1500);
  }

  // 記錄按鈕可用狀態
  function refreshRecordButtons(){
    var snap=snapshot();
    var needFull = !!(els.onlyFull && els.onlyFull.checked);
    var enabled = snap.parts.length>0 && (!needFull || snap.isFull);
    if(els.btnRecord) els.btnRecord.disabled = !enabled;
    if(els.fabRecord){
      if(enabled){ els.fabRecord.className='record-fab'; }
      else{ els.fabRecord.className='record-fab disabled'; }
    }
  }

  // 「記錄這筆結果」：不播放彩帶
  function recordNow(){
    var snap=snapshot();
    var needFull = !!(els.onlyFull && els.onlyFull.checked);
    if(snap.parts.length===0){ setWarning('目前沒有可記錄的內容'); return; }
    if(needFull && !snap.isFull){ setWarning('已啟用「只允許完整才可記錄」；請先補齊年級/班級/座號'); return; }
    setWarning('');
    addLogWithEffects(snap.fullText, false); // ← 不放彩帶
  }

  // 「抽籤」（整組）：逐步等待動畫完成 → 再記錄完整一筆（會放彩帶）
  function clampDrawCount(){ var v=parseInt((els.drawCount && els.drawCount.value)||'1',10); if(isNaN(v)||v<1) v=1; if(v>10) v=10; if(els.drawCount) els.drawCount.value=v; return v; }
  function drawSequence(){
    var times=clampDrawCount(); if(els.progress) els.progress.style.width='0%';
    var i=0;
    function runOne(){
      // 依序等待每一步完成（用 onDone 串接）
      drawOne({min:els.gradeMin.value,max:els.gradeMax.value,resultEl:els.gradeResult,type:'grade',fixed:els.fixedGrade.checked,noRepeat:els.noRepeatGrade.checked,history:gradeHistory,animate:times===1,onDone:function(){
        drawOne({min:els.classMin.value,max:els.classMax.value,resultEl:els.classResult,type:'class',fixed:els.fixedClass.checked,noRepeat:els.noRepeatClass.checked,history:classHistory,animate:times===1,onDone:function(){
          drawOne({min:els.seatMin.value,max:els.seatMax.value,resultEl:els.seatResult,type:'seat',fixed:els.fixedSeat.checked,noRepeat:els.noRepeatSeat.checked,history:seatHistory,animate:times===1,onDone:function(){
            var snap=snapshot(); // ← 此刻三個都已停下
            if(snap.isFull){ addLogWithEffects(snap.fullText,true); }
            if(els.progress) els.progress.style.width=(((i+1)/times)*100)+'%';
            i++; if(i<times){ setTimeout(runOne, times===1?150:0); }
          }}); // seat onDone
        }});   // class onDone
      }});     // grade onDone
    }
    runOne();
  }

  // 綁定事件
  if(els.btnDrawGrade) els.btnDrawGrade.addEventListener('click',function(){ drawOne({min:els.gradeMin.value,max:els.gradeMax.value,resultEl:els.gradeResult,type:'grade',fixed:els.fixedGrade.checked,noRepeat:els.noRepeatGrade.checked,history:gradeHistory,animate:true}); diag('已觸發：抽年級',true); });
  if(els.btnDrawClass) els.btnDrawClass.addEventListener('click',function(){ drawOne({min:els.classMin.value,max:els.classMax.value,resultEl:els.classResult,type:'class',fixed:els.fixedClass.checked,noRepeat:els.noRepeatClass.checked,history:classHistory,animate:true}); diag('已觸發：抽班級',true); });
  if(els.btnDrawSeat)  els.btnDrawSeat .addEventListener('click',function(){ drawOne({min:els.seatMin.value,max:els.seatMax.value,resultEl:els.seatResult,type:'seat', fixed:els.fixedSeat.checked,noRepeat:els.noRepeatSeat.checked,history:seatHistory,animate:true}); diag('已觸發：抽座號',true); });

  if(els.btnRecord) els.btnRecord.addEventListener('click', function(){ recordNow(); });
  if(els.fabRecord) els.fabRecord.addEventListener('click', function(){ recordNow(); });

  if(els.onlyFull) els.onlyFull.addEventListener('change', refreshRecordButtons);

  if(els.btnDrawAll) els.btnDrawAll.addEventListener('click', function(){ drawSequence(); diag('已觸發：抽籤（整組）',true); });
  document.addEventListener('keydown',function(e){
    if(e.key==='Enter'){ if(e.preventDefault) e.preventDefault(); drawSequence(); }
    if(e.key==='r' || e.key==='R'){ if(e.preventDefault) e.preventDefault(); recordNow(); }
  });

  // 範圍改變時刷新記錄按鈕（避免舊值超出範圍）
  var kinds=['grade','class','seat'];
  for(var k=0;k<kinds.length;k++){
    (function(kind){
      var minEl=els[kind+'Min'], maxEl=els[kind+'Max'], resEl=els[kind+'Result']; if(!minEl||!maxEl||!resEl) return;
      function check(){
        var min=parseInt(minEl.value,10), max=parseInt(maxEl.value,10), v=parseInt((resEl.dataset&&resEl.dataset.value)||'');
        if(!isNaN(v)&&(v<min||v>max)){
          resEl.textContent='?'; if(resEl.dataset) delete resEl.dataset.value;
          if(kind==='grade'){ currentGrade=null; gradeHistory=[]; }
          if(kind==='class'){ currentClass=null; classHistory=[]; }
          if(kind==='seat'){  currentSeat=null;  seatHistory=[];  }
        }
        setWarning(''); refreshRecordButtons();
      }
      minEl.addEventListener('change',check); maxEl.addEventListener('change',check);
    })(kinds[k]);
  }

  // 列印
  function nowStamp(){ var d=new Date(); function pad(n){ return n<10?'0'+n:n; } return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())+' '+pad(d.getHours())+':'+pad(d.getMinutes())+':'+pad(d.getSeconds()); }
  if(els.btnPrint) els.btnPrint.addEventListener('click',function(){ if(els.printHeader) els.printHeader.textContent='抽籤結果清單（共 '+resultsHistory.length+' 筆）｜列印時間：'+nowStamp(); window.print(); });

  // 清除 / 重置 / 全螢幕
  if(els.btnClearLog) els.btnClearLog.addEventListener('click',function(){ if(!confirm('確定要清除下方抽籤紀錄？（不影響目前年級/班級/座號顯示）')) return; resultsHistory=[]; updateLog(); setWarning('已清除紀錄'); refreshRecordButtons(); });
  if(els.btnResetAll) els.btnResetAll.addEventListener('click',function(){ if(!confirm('將重置所有設定與紀錄，確定嗎？')) return; resetAll(); setWarning('已重置所有設定與紀錄'); });
  if(els.btnFullscreen) els.btnFullscreen.addEventListener('click',function(){ try{ if(!document.fullscreenElement){ document.documentElement.requestFullscreen(); } else { document.exitFullscreen(); } }catch(e){} });

  // 彩帶（相容）
  var confettiCanvas=$id('confettiCanvas'); var ctx=confettiCanvas.getContext('2d');
  function startConfetti(duration){ if(typeof duration==='undefined') duration=1800; var W=confettiCanvas.width=window.innerWidth, H=confettiCanvas.height=window.innerHeight; confettiCanvas.style.display='block'; var TAU=Math.PI*2; var colors=['#ff4d6d','#ffd166','#06d6a0','#118ab2','#9b5de5','#f15bb5','#00bbf9']; var particles=[]; function rand(a,b){ return Math.random()*(b-a)+a; } function pick(arr){ return arr[(Math.random()*arr.length)|0]; }
    function spawnBurst(cx,cy,count,spread,impulse){ for(var i=0;i<count;i++){ var ang=rand(-spread,spread)+(i%2?0:Math.PI); var speed=impulse*rand(0.65,1.1); var vx=Math.cos(ang)*speed+rand(-0.6,0.6); var vy=Math.sin(ang)*speed+rand(-0.2,0.2); var size=rand(6,14); var type=pick(['rect','tri','circle']); var color=pick(colors); particles.push({x:cx,y:cy,vx:vx,vy:vy,size:size,rot:rand(0,TAU),vr:rand(-0.3,0.3),life:1,shape:type,c:color}); } }
    function spawnStreamer(){ var x=rand(0,W); for(var i=0;i<3;i++){ var size=rand(5,10); particles.push({x:x+rand(-20,20),y:-10,vx:rand(-0.8,0.8),vy:rand(2.2,3.3),size:size,rot:rand(0,TAU),vr:rand(-0.2,0.2),life:1,shape:pick(['rect','tri']),c:pick(colors)}); } }
    spawnBurst(W*0.25,H*0.35,90,Math.PI/2.2,6.2); spawnBurst(W*0.75,H*0.35,90,Math.PI/2.2,6.2); spawnBurst(W*0.50,H*0.40,60,Math.PI/2.6,7.0);
    var last=Date.now(); var t0=Date.now();
    function step(){ var t=Date.now(); var dt=Math.min(40,(t-last)); last=t; var dtf=dt/16.6667; var elapsed=t-t0; if(elapsed<duration){ if(Math.random()<0.9) spawnStreamer(); } var drag=0.985, gravity=0.22, wind=Math.sin(t*0.0025)*0.12; ctx.clearRect(0,0,W,H); for(var i=particles.length-1;i>=0;i--){ var p=particles[i]; p.vx=(p.vx+wind)*drag; p.vy=(p.vy+gravity)*drag; p.x+=p.vx*dtf; p.y+=p.vy*dtf; p.rot+=p.vr*dtf; if(elapsed>duration*0.65) p.life-=0.012*dtf; else p.life-=0.0045*dtf; ctx.save(); ctx.globalAlpha=Math.max(0,Math.min(1,p.life)); ctx.translate(p.x,p.y); ctx.rotate(p.rot); ctx.fillStyle=p.c; if(p.shape==='rect'){ ctx.fillRect(-p.size*0.5,-p.size*0.2,p.size,p.size*0.4); } else if(p.shape==='tri'){ ctx.beginPath(); ctx.moveTo(0,-p.size*0.6); ctx.lineTo(p.size*0.6,p.size*0.6); ctx.lineTo(-p.size*0.6,p.size*0.6); ctx.closePath(); ctx.fill(); } else { ctx.beginPath(); ctx.arc(0,0,p.size*0.35,0,TAU); ctx.fill(); } ctx.restore(); if(p.y>H+40||p.life<=0) particles.splice(i,1); } if(elapsed<duration||particles.length>0){ if(window.requestAnimationFrame) window.requestAnimationFrame(step); else setTimeout(step,16); } else confettiCanvas.style.display='none'; }
    if(window.requestAnimationFrame) window.requestAnimationFrame(step); else setTimeout(step,16);
  }

  // 啟動
  restore(); updateLog(); refreshRecordButtons();
})();
</script>
</body>
</html>